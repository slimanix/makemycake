<div class="client-commandes-wrapper">
  <h2 class="title">Mes Commandes</h2>
  <div class="filter-row mb-6 flex items-center gap-4">
    <label for="statut-select" class="font-medium text-gray-700">Filtrer par statut :</label>
    <select id="statut-select" [(ngModel)]="selectedStatut" (ngModelChange)="currentPage = 1" class="border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pink-300">
      <option value="">Tous</option>
      <option value="EN_ATTENTE">En attente</option>
      <option value="PREPARATION">Préparation</option>
      <option value="LIVRAISON">Livraison</option>
      <option value="TERMINEE">Terminée</option>
      <option value="ANNULEE">Annulée</option>
    </select>
  </div>
  <div *ngIf="isLoading" class="loading">Chargement des commandes...</div>
  <div *ngIf="error" class="error">{{ error }}</div>
  <div *ngIf="!isLoading && !error && filteredCommandes.length === 0" class="empty">Aucune commande trouvée.</div>
  <div *ngIf="!isLoading && paginatedCommandes.length > 0">
    <div class="commandes-list flex flex-col gap-6">
      <div *ngFor="let commande of paginatedCommandes" class="commande-card bg-pink-50 rounded-xl shadow-sm p-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4 border border-pink-100 hover:shadow-md transition-shadow">
        <div class="flex flex-col md:flex-row md:items-center gap-4 flex-1">
          <div class="commande-patisserie font-semibold text-pink-800 min-w-[160px]">{{ commande.patisserieNom }}</div>
          <div class="commande-date text-gray-500 font-medium min-w-[120px]">{{ commande.dateCreation | date:'short' }}</div>
          <div class="commande-montant font-bold text-lg text-gray-900">{{ commande.montantTotal | number:'1.2-2' }} DHS</div>
          <div class="commande-telephone text-gray-700 min-w-[120px]">{{ commande.client.telephone || commande.telephoneClient }}</div>
        </div>
        <div class="flex items-center gap-6 mt-2 md:mt-0">
          <span class="commande-statut ml-2 px-3 py-1 rounded-full text-sm font-semibold"
            [ngClass]="{
              'statut-annulee': commande.statut.trim().toUpperCase() === 'ANNULEE',
              'statut-validee': commande.statut.trim().toUpperCase() === 'VALIDEE',
              'statut-en-cours': commande.statut.trim().toUpperCase() === 'EN_COURS',
              'statut-attente': commande.statut.trim().toUpperCase() === 'EN_ATTENTE',
              'statut-preparation': commande.statut.trim().toUpperCase() === 'PREPARATION',
              'statut-livraison': commande.statut.trim().toUpperCase() === 'LIVRAISON',
              'statut-terminee': commande.statut.trim().toUpperCase() === 'TERMINEE'
            }">
            {{ commande.statut.trim() }}
          </span>
          <button *ngIf="commande.statut === 'EN_ATTENTE'" (click)="openPaymentModal(commande.id)" class="bg-green-600 text-white px-4 py-2 rounded font-semibold hover:bg-green-700 transition">
            Payer
          </button>
          <button *ngIf="commande.statut !== 'LIVRAISON' && commande.statut !== 'TERMINEE' && commande.statut !== 'ANNULEE'" (click)="cancelCommande(commande.id)" [disabled]="cancelLoadingId === commande.id" class="ml-2 bg-red-600 text-white px-4 py-2 rounded font-semibold hover:bg-red-700 transition flex items-center">
            <span *ngIf="cancelLoadingId !== commande.id">Annuler</span>
            <span *ngIf="cancelLoadingId === commande.id" class="animate-spin mr-2">⏳</span>
            <span *ngIf="cancelLoadingId === commande.id">Annulation...</span>
          </button>
          <span *ngIf="cancelSuccessId === commande.id" class="text-green-600 ml-2 font-semibold">Commande annulée !</span>
          <span *ngIf="cancelError && cancelLoadingId === commande.id" class="text-red-600 ml-2">{{ cancelError }}</span>
        </div>
      </div>
    </div>
    <!-- Pagination controls -->
    <div class="pagination flex justify-center items-center gap-2 mt-6" *ngIf="totalPages > 1">
      <button (click)="prevPage()" [disabled]="currentPage === 1" class="px-3 py-1 rounded bg-gray-200 text-gray-700 font-semibold hover:bg-pink-100">&laquo;</button>
      <ng-container *ngFor="let page of [].constructor(totalPages); let i = index">
        <button (click)="goToPage(i + 1)" [class.bg-pink-500]="currentPage === (i + 1)" [class.text-white]="currentPage === (i + 1)" class="px-3 py-1 rounded font-semibold" [ngClass]="{'bg-gray-200 text-gray-700 hover:bg-pink-100': currentPage !== (i + 1)}">{{ i + 1 }}</button>
      </ng-container>
      <button (click)="nextPage()" [disabled]="currentPage === totalPages" class="px-3 py-1 rounded bg-gray-200 text-gray-700 font-semibold hover:bg-pink-100">&raquo;</button>
    </div>
  </div>
</div>

<div *ngIf="showPaymentModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40">
  <div class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md relative">
    <button (click)="closePaymentModal()" class="absolute top-3 right-3 text-gray-400 hover:text-gray-700 text-xl">&times;</button>
    <h3 class="text-xl font-bold mb-4 text-pink-700">Paiement de la commande #{{ paymentCommandeId }}</h3>
    <form (ngSubmit)="submitPayment()" *ngIf="!paymentSuccess">
      <div class="mb-4">
        <label class="block text-gray-700 font-medium mb-1">Numéro de carte</label>
        <input type="text" [(ngModel)]="paymentForm.numeroCarte" name="numeroCarte" maxlength="19" class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pink-300" required autocomplete="cc-number">
      </div>
      <div class="mb-4 flex gap-4">
        <div class="flex-1">
          <label class="block text-gray-700 font-medium mb-1">Date d'expiration</label>
          <input type="text" [(ngModel)]="paymentForm.dateExpiration" name="dateExpiration" maxlength="5" placeholder="MM/AA" class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pink-300" required autocomplete="cc-exp">
        </div>
        <div class="flex-1">
          <label class="block text-gray-700 font-medium mb-1">CVV</label>
          <input type="password" [(ngModel)]="paymentForm.cvv" name="cvv" maxlength="4" class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pink-300" required autocomplete="cc-csc">
        </div>
      </div>
      <div *ngIf="paymentError" class="text-red-600 mb-2">{{ paymentError }}</div>
      <button type="submit" [disabled]="paymentLoading" class="w-full bg-pink-600 text-white font-semibold py-2 rounded hover:bg-pink-700 transition disabled:opacity-60">
        <span *ngIf="!paymentLoading">Payer</span>
        <span *ngIf="paymentLoading" class="animate-spin inline-block mr-2">⏳</span>
        <span *ngIf="paymentLoading">Paiement...</span>
      </button>
    </form>
    <div *ngIf="paymentSuccess" class="text-green-600 text-center font-semibold py-6">
      Paiement réussi !
    </div>
  </div>
</div>

<div *ngIf="cancelSuccessId" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40">
  <div class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md text-center">
    <h3 class="text-2xl font-bold mb-4 text-red-700">Commande annulée avec succès !</h3>
    <div class="text-red-600 text-lg font-semibold">Le statut de la commande a été changé à ANNULÉE.</div>
  </div>
</div> 